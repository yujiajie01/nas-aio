# NAS 自动化系统测试计划

## 测试概述

本文档描述了 NAS 自动化影音管理系统的完整测试策略，包括单元测试、集成测试、性能测试和用户验收测试。

## 测试策略

### 测试金字塔
```
    用户验收测试 (E2E)
         集成测试
       系统测试 & 性能测试
          单元测试
```

### 测试环境
- **开发环境**: 本地开发机器
- **测试环境**: 独立的测试服务器
- **生产环境**: 实际部署的 NAS 系统

## 测试分类

### 1. 单元测试 (Unit Tests)

**目标**: 验证各个独立组件的功能正确性

**覆盖范围**:
- 配置文件解析
- 目录结构创建
- 权限设置
- 日志处理
- 错误处理
- 网络连接函数
- 文件操作函数

**执行方式**:
```bash
./tests/unit-tests.sh
```

**预期结果**:
- 所有单元测试通过
- 代码覆盖率 > 80%

### 2. 集成测试 (Integration Tests)

**目标**: 验证系统各组件间的协作功能

**测试场景**:

#### 2.1 容器间通信测试
- MoviePilot ↔ qBittorrent API 通信
- MoviePilot ↔ Emby API 通信
- MoviePilot ↔ Transmission API 通信
- CookieCloud 与各服务的认证同步

#### 2.2 数据流测试
- 下载完成后的文件自动整理
- 媒体库自动刷新
- 元数据自动刮削
- 微信通知发送

#### 2.3 存储挂载测试
- 共享存储卷的正确挂载
- 文件权限的正确映射
- 跨容器的文件访问

### 3. 系统测试 (System Tests)

**目标**: 验证完整系统的功能性和稳定性

**执行方式**:
```bash
./tests/system-test.sh
```

**测试矩阵**:

| 测试类别 | 测试项目 | 通过标准 | 优先级 |
|---------|---------|---------|--------|
| 基础环境 | Docker 服务状态 | 服务运行正常 | P0 |
| 基础环境 | 目录结构完整性 | 所有必需目录存在 | P0 |
| 网络连接 | 外网连接 | 能够访问外部网络 | P0 |
| 网络连接 | 容器间通信 | 所有服务间可通信 | P0 |
| 服务状态 | 核心容器运行 | 所有核心容器健康 | P0 |
| Web 访问 | 服务界面可访问 | HTTP 200-299 响应 | P1 |
| API 接口 | 关键 API 响应 | API 返回有效数据 | P1 |
| 数据存储 | 文件读写权限 | 能够正常读写文件 | P1 |
| 安全配置 | 默认密码检查 | 密码已修改 | P2 |

### 4. 性能测试 (Performance Tests)

**目标**: 验证系统在各种负载下的性能表现

**执行方式**:
```bash
./tests/performance-test.sh
```

**性能指标**:

#### 4.1 系统资源使用
| 指标 | 正常范围 | 警告阈值 | 告警阈值 |
|------|---------|---------|---------|
| CPU 使用率 | < 50% | 50-80% | > 80% |
| 内存使用率 | < 70% | 70-85% | > 85% |
| 磁盘 I/O 等待 | < 10% | 10-20% | > 20% |
| 系统负载 | < 1.0/核心 | 1.0-2.0/核心 | > 2.0/核心 |

#### 4.2 应用性能
| 指标 | 正常范围 | 警告阈值 | 告警阈值 |
|------|---------|---------|---------|
| Web 界面响应时间 | < 2s | 2-5s | > 5s |
| API 响应时间 | < 1s | 1-3s | > 3s |
| 磁盘读写速度 | > 50MB/s | 20-50MB/s | < 20MB/s |
| 并发处理能力 | > 10 req/s | 5-10 req/s | < 5 req/s |

#### 4.3 负载测试场景
- **正常负载**: 5-10 个并发下载任务
- **高负载**: 20-50 个并发下载任务
- **峰值负载**: 100+ 个并发请求
- **长时间运行**: 连续运行 24 小时

### 5. 用户验收测试 (UAT)

**目标**: 从用户角度验证系统可用性

#### 5.1 核心用户流程测试

**流程 1: 添加电影下载**
1. 访问 MoviePilot Web 界面
2. 搜索电影资源
3. 选择合适的资源质量
4. 添加到下载队列
5. 验证 qBittorrent 开始下载
6. 等待下载完成
7. 验证文件自动整理到媒体库
8. 验证 Emby 中出现新内容
9. 验证微信通知接收

**流程 2: 设置电视剧订阅**
1. 在 MoviePilot 中搜索电视剧
2. 设置订阅规则（质量、字幕等）
3. 添加到订阅列表
4. 模拟新剧集发布
5. 验证自动下载新剧集
6. 验证自动整理和通知

**流程 3: 多设备访问**
1. 手机访问 Emby 客户端
2. 验证内容同步显示
3. 测试视频播放功能
4. 测试投屏到电视
5. 验证观看进度同步

#### 5.2 扩展功能测试

**漫画管理**:
1. 上传漫画资源到指定目录
2. 验证 Komga 自动扫描
3. 测试在线阅读功能

**音乐管理**:
1. 添加音乐文件到媒体库
2. 验证 Navidrome 扫描和索引
3. 测试播放和歌单功能

**有声书管理**:
1. 添加有声书文件
2. 验证 Audiobookshelf 识别
3. 测试播放和进度记忆

## 测试执行计划

### 测试周期
- **开发阶段**: 每次代码提交后执行单元测试
- **集成阶段**: 每日执行集成测试
- **发布前**: 完整执行所有测试套件
- **生产环境**: 定期执行系统监控测试

### 自动化执行
```bash
# 完整测试套件
./run-all-tests.sh

# 快速验证测试
./run-quick-tests.sh

# 性能基准测试
./tests/performance-test.sh --quick

# 持续监控测试
./tests/system-test.sh --daemon
```

## 测试数据管理

### 测试数据准备
- **配置文件模板**: 标准和异常配置场景
- **媒体样本文件**: 各种格式和大小的测试文件
- **网络模拟**: 不同网络条件下的测试
- **负载模拟**: 批量操作和并发请求

### 测试环境隔离
- 使用独立的测试数据目录
- 模拟不同的硬件配置
- 网络隔离和安全测试

## 测试结果报告

### 报告格式
```
测试执行报告
================
测试时间: 2024-01-01 10:00:00
测试环境: Test Server v1.0
测试执行人: 自动化测试

测试概览:
- 总测试数: 150
- 通过数: 145
- 失败数: 3
- 跳过数: 2
- 成功率: 96.7%

失败测试详情:
1. [FAIL] API响应时间测试 - 响应时间5.2s超过阈值3s
2. [FAIL] 并发下载测试 - 50并发时系统负载过高
3. [FAIL] 微信通知测试 - 配置错误导致发送失败

性能指标:
- 平均CPU使用率: 45%
- 平均内存使用率: 68%
- 磁盘IO性能: 120MB/s读, 95MB/s写
- 网络响应延迟: 15ms

建议:
1. 优化API响应性能
2. 调整并发处理策略
3. 检查微信通知配置
```

### 报告分发
- 自动发送到开发团队邮箱
- 集成到项目管理系统
- 生成趋势分析图表

## 质量门禁

### 发布标准
- 单元测试通过率 ≥ 95%
- 集成测试通过率 ≥ 90%
- 系统测试通过率 ≥ 95%
- 性能测试无严重问题
- 用户验收测试通过

### 问题分级
- **P0 (阻塞)**: 系统无法启动、核心功能完全不可用
- **P1 (严重)**: 主要功能异常、性能严重下降
- **P2 (一般)**: 次要功能问题、轻微性能影响
- **P3 (轻微)**: 界面问题、文档错误

## 测试工具链

### 测试框架
- **Shell Script**: 系统级测试脚本
- **Docker**: 容器化测试环境
- **curl**: HTTP 接口测试
- **jq**: JSON 数据处理

### 监控工具
- **Prometheus**: 指标收集
- **Grafana**: 性能可视化
- **UptimeKuma**: 服务可用性监控

### 持续集成
- **GitHub Actions**: 自动化测试执行
- **Docker Hub**: 镜像构建和分发
- **Webhook**: 测试结果通知

## 风险评估

### 测试风险
- **环境差异**: 测试环境与生产环境不一致
- **数据安全**: 测试过程中的数据泄露风险
- **资源消耗**: 性能测试对系统资源的影响
- **时间限制**: 测试执行时间过长影响发布节奏

### 缓解措施
- 使用容器技术标准化环境
- 实施测试数据脱敏策略
- 设置资源使用限制
- 优化测试执行效率

## 持续改进

### 测试覆盖率监控
- 定期评估测试覆盖率
- 识别未覆盖的功能模块
- 补充遗漏的测试用例

### 测试效率优化
- 并行化测试执行
- 优化测试数据准备
- 自动化测试环境搭建

### 反馈循环
- 收集用户反馈
- 分析生产环境问题
- 不断完善测试策略