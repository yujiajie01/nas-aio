name: NAS è‡ªåŠ¨åŒ–ç³»ç»Ÿ CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæµ‹è¯•
    - cron: '0 2 * * *'

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: nas-aio

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: Shell è„šæœ¬è¯­æ³•æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ Shell è„šæœ¬è¯­æ³•..."
        find . -name "*.sh" -type f | while read -r script; do
          echo "æ£€æŸ¥: $script"
          bash -n "$script" || exit 1
        done
        
    - name: Docker Compose é…ç½®éªŒè¯
      run: |
        echo "éªŒè¯ Docker Compose é…ç½®..."
        # åˆ›å»ºä¸´æ—¶ç¯å¢ƒå˜é‡æ–‡ä»¶
        cp .env.template .env
        
        # éªŒè¯æ ¸å¿ƒæœåŠ¡é…ç½®
        docker-compose -f docker-compose.core.yml config -q
        
        # éªŒè¯æ‰©å±•æœåŠ¡é…ç½®
        docker-compose -f docker-compose.extend.yml config -q
        
        # éªŒè¯ç›‘æ§æœåŠ¡é…ç½®
        docker-compose -f docker-compose.monitoring.yml config -q
        
    - name: Markdown æ–‡æ¡£æ£€æŸ¥
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'

  # å•å…ƒæµ‹è¯•
  unit-tests:
    runs-on: ubuntu-latest
    name: å•å…ƒæµ‹è¯•
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y curl wget jq bc
        
    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        chmod +x tests/unit-tests.sh
        ./tests/unit-tests.sh
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results
        path: /tmp/nas-unit-tests/

  # é›†æˆæµ‹è¯•
  integration-tests:
    runs-on: ubuntu-latest
    name: é›†æˆæµ‹è¯•
    needs: unit-tests
    
    services:
      # Redis for testing
      redis:
        image: redis:alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: å‡†å¤‡æµ‹è¯•ç¯å¢ƒ
      run: |
        # åˆ›å»ºæµ‹è¯•ç›®å½•
        sudo mkdir -p /opt/nas-data/{downloads,media,config,logs}
        sudo chown -R $USER:$USER /opt/nas-data
        
        # åˆ›å»ºæµ‹è¯•é…ç½®
        cp .env.template .env
        sed -i 's/your_api_token_here/test_token_123/' .env
        sed -i 's/your_emby_api_key_here/test_emby_key/' .env
        sed -i 's/adminpass/test_qb_pass/' .env
        sed -i 's/password123/test_tr_pass/' .env
        
    - name: å¯åŠ¨æ ¸å¿ƒæœåŠ¡è¿›è¡Œæµ‹è¯•
      run: |
        # åˆ›å»ºç½‘ç»œ
        docker network create --driver bridge --subnet=172.20.0.0/16 nas-network || true
        
        # å¯åŠ¨æ ¸å¿ƒæœåŠ¡ï¼ˆä½¿ç”¨è½»é‡çº§é•œåƒè¿›è¡Œæµ‹è¯•ï¼‰
        docker-compose -f docker-compose.core.yml up -d --wait
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 30
        
    - name: è¿è¡Œé›†æˆæµ‹è¯•
      run: |
        chmod +x tests/system-test.sh
        ./tests/system-test.sh --quick
        
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        chmod +x tests/performance-test.sh  
        ./tests/performance-test.sh --quick
        
    - name: æ”¶é›†æœåŠ¡æ—¥å¿—
      if: failure()
      run: |
        echo "=== Docker æœåŠ¡çŠ¶æ€ ==="
        docker ps -a
        
        echo "=== å®¹å™¨æ—¥å¿— ==="
        docker-compose -f docker-compose.core.yml logs
        
    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: /tmp/nas-*-test*.log

  # Docker é•œåƒæ„å»ºå’Œæ¨é€
  build-and-push:
    runs-on: ubuntu-latest
    name: æ„å»ºå’Œæ¨é€é•œåƒ
    needs: integration-tests
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
      
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ç™»å½•åˆ° Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          
    - name: æ„å»ºå¹¶æ¨é€é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # éƒ¨ç½²æµ‹è¯•
  deployment-test:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²æµ‹è¯•
    needs: build-and-push
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æ¨¡æ‹Ÿéƒ¨ç½²æµ‹è¯•
      run: |
        echo "=== éƒ¨ç½²å‰æ£€æŸ¥ ==="
        
        # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
        required_files=(
          "install.sh"
          "docker-compose.core.yml"  
          "docker-compose.extend.yml"
          ".env.template"
        )
        
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "é”™è¯¯: ç¼ºå°‘å¿…éœ€æ–‡ä»¶ $file"
            exit 1
          fi
          echo "âœ“ $file å­˜åœ¨"
        done
        
        echo "=== è„šæœ¬æƒé™æ£€æŸ¥ ==="
        chmod +x install.sh setup-directories.sh
        chmod +x scripts/*.sh
        chmod +x tests/*.sh
        
        echo "=== é…ç½®æ–‡ä»¶éªŒè¯ ==="
        if ! grep -q "PUID=" .env.template; then
          echo "é”™è¯¯: é…ç½®æ¨¡æ¿ç¼ºå°‘å¿…éœ€å˜é‡"
          exit 1
        fi
        
        echo "âœ“ éƒ¨ç½²æµ‹è¯•é€šè¿‡"

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ
    needs: code-quality
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ä¸Šä¼  Trivy æ‰«æç»“æœåˆ° GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: æ£€æŸ¥æ•æ„Ÿä¿¡æ¯
      run: |
        echo "æ£€æŸ¥æ•æ„Ÿä¿¡æ¯æ³„éœ²..."
        
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡¬ç¼–ç å¯†ç 
        if grep -r -E "(password|passwd|pwd).*(=|:).*(123|admin|root|password)" . --exclude-dir=.git; then
          echo "è­¦å‘Š: å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç å¯†ç "
        fi
        
        # æ£€æŸ¥ API å¯†é’¥æ ¼å¼
        if grep -r -E "[a-zA-Z0-9]{32,}" . --exclude-dir=.git --exclude="*.md" | grep -v template; then
          echo "è­¦å‘Š: å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç  API å¯†é’¥"  
        fi

  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-benchmark:
    runs-on: ubuntu-latest
    name: æ€§èƒ½åŸºå‡†æµ‹è¯•
    needs: integration-tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[benchmark]')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ
      run: |
        sudo mkdir -p /opt/nas-data
        sudo chown -R $USER:$USER /opt/nas-data
        cp .env.template .env
        
    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•  
      run: |
        chmod +x tests/performance-test.sh
        ./tests/performance-test.sh --time 300  # 5åˆ†é’Ÿæµ‹è¯•
        
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: performance-benchmark-results
        path: /tmp/nas-performance-report.txt

  # å‘å¸ƒé€šçŸ¥
  notify:
    runs-on: ubuntu-latest
    name: å‘å¸ƒé€šçŸ¥
    needs: [build-and-push, deployment-test]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: needs.build-and-push.result == 'success' && needs.deployment-test.result == 'success'
      run: |
        echo "ğŸš€ NAS è‡ªåŠ¨åŒ–ç³»ç»Ÿæ„å»ºæˆåŠŸï¼"
        echo "- åˆ†æ”¯: ${{ github.ref_name }}"
        echo "- æäº¤: ${{ github.sha }}"
        echo "- ä½œè€…: ${{ github.actor }}"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥ç³»ç»Ÿ
        # curl -X POST "webhook_url" -d "NASç³»ç»Ÿæ„å»ºæˆåŠŸ"
        
    - name: å‘é€å¤±è´¥é€šçŸ¥  
      if: needs.build-and-push.result == 'failure' || needs.deployment-test.result == 'failure'
      run: |
        echo "âŒ NAS è‡ªåŠ¨åŒ–ç³»ç»Ÿæ„å»ºå¤±è´¥ï¼"
        echo "- åˆ†æ”¯: ${{ github.ref_name }}"
        echo "- æäº¤: ${{ github.sha }}"
        echo "- é”™è¯¯: æ„å»ºæˆ–éƒ¨ç½²æµ‹è¯•å¤±è´¥"
        
        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„é€šçŸ¥ç³»ç»Ÿ
        # curl -X POST "webhook_url" -d "NASç³»ç»Ÿæ„å»ºå¤±è´¥"